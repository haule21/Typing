name: Publish Release Asset

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      # 1. 인증서 생성 (MSIX 빌드를 위해 필수)
      - name: Create Signing Certificate
        run: |
          $cert = New-SelfSignedCertificate -CertStoreLocation "cert:\CurrentUser\My" -Subject "CN=TypingApp" -KeyAlgorithm RSA -KeyLength 2048 -HashAlgorithm SHA256 -Type CodeSigningCert
          $pwd = ConvertTo-SecureString -String "TypingAppPassword" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "TypingCert.pfx" -Password $pwd

      # 2. MSIX 패키지 빌드 (msbuild /restore 사용하여 Assets 파일 에러 해결)
      - name: Build and Package MSIX
        run: |
          # dotnet publish를 사용하여 MSIX 패키징 타겟을 '강제로' 실행합니다.
          dotnet publish TypingApp.csproj `
            -c Release `
            -r win-x64 `
            -p:PublishAppxPackage=true `
            -p:AppxPackageSigningEnabled=true `
            -p:PackageCertificateKeyFile="TypingCert.pfx" `
            -p:PackageCertificatePassword="TypingAppPassword" `
            -p:AppxPackageDir="${{ github.workspace }}\AppxPackages\\" `
            -p:AppxBundle=Always `
            --self-contained true

      # 3. 디버깅용 파일 리스트 출력 (파일을 못 찾을 경우 로그 확인용)
      - name: Debug - List All Workspace Files
        if: always()
        run: |
          Write-Host "--- 전체 파일 구조 검색 ---"
          Get-ChildItem -Path . -Recurse -Include *.msix, *.msixbundle, *.appxbundle | Select-Object FullName

      # 4. 파일 수집 및 스테이징
      - name: Locate and Stage MSIX Files
        run: |
          New-Item -ItemType Directory -Force -Path "FinalOutput"
          
          # 1. 먼저 명시적인 경로에서 검색
          $searchPaths = @("${{ github.workspace }}\AppxPackages", ".")
          
          foreach ($path in $searchPaths) {
              Write-Host "Searching in: $path"
              $found = Get-ChildItem -Path $path -Recurse -Include *.msixbundle, *.msix, *.appxbundle | Where-Object { $_.FullName -notmatch "obj|FinalOutput|_Test" }
              if ($found) {
                  $found | ForEach-Object {
                      Write-Host "✅ 패키지 발견: $($_.FullName)"
                      Copy-Item $_.FullName -Destination "FinalOutput"
                  }
                  $hasFiles = $true
              }
          }
          
          if (-not $hasFiles) {
              Write-Error "❌ 빌드는 성공했으나 MSIX 파일이 생성되지 않았습니다. 로그에서 'Appx' 관련 타겟이 실행되었는지 확인하세요."
              exit 1
          }

      # 5. 릴리스 생성 및 업로드
      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        with:
          files: |
            FinalOutput/*.msixbundle
            FinalOutput/*.msix
            FinalOutput/*.appxbundle
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}