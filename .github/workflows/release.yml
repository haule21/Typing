name: Publish Release Asset

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Publish MSIX Package
        run: |
          # Use dotnet publish as requested, with explicit MSIX properties
          # We pass WindowsPackageType=MSIX to ensure the MSIX targets are invoked
          dotnet publish TypingApp.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=false `
            -p:WindowsPackageType=MSIX `
            -p:AppxPackageSigningEnabled=true `
            -p:PackageCertificateKeyFile="TypingCert.pfx" `
            -p:PackageCertificatePassword="TypingAppPassword" `
            -p:AppxPackageDir="${{ github.workspace }}\AppxPackages\\" `
            -p:GenerateAppxPackageOnBuild=true `
            -p:AppxBundle=Always `
            -p:UapAppxPackageBuildMode=SideloadOnly

      - name: List All Workspace Files (Debug)
        if: always()
        run: |
          # Debug: Recursively list all files to find where the MSIX went if it's missing
          Get-ChildItem -Path . -Recurse -Filter "*.msix*" | Select-Object FullName

      - name: Locate and Stage MSIX Files
        run: |
          New-Item -ItemType Directory -Force -Path "FinalOutput"
          
          # Search in the explicit AppxPackages directory first
          $searchPath = "${{ github.workspace }}\AppxPackages"
          if (-not (Test-Path $searchPath)) {
             Write-Host "AppxPackages path not found, searching entire workspace..."
             $searchPath = "."
          }

          $files = Get-ChildItem -Path $searchPath -Recurse -Include *.msixbundle, *.msix, *.appxbundle | Where-Object { $_.FullName -notlike "*FinalOutput*" }
          
          if ($files) {
              foreach ($f in $files) {
                  Write-Host "Found artifact: $($f.FullName)"
                  Copy-Item $f.FullName -Destination "FinalOutput"
              }
          } else {
              Write-Error "CRITICAL: No MSIX files found anywhere!"
              exit 1
          }

      - name: List All Workspace Files (Debug)
        if: always()
        run: |
          # Debug: Recursively list all files to find where the MSIX went if it's missing
          Get-ChildItem -Path . -Recurse -Filter "*.msix*" | Select-Object FullName

      - name: Locate and Stage MSIX Files
        run: |
          New-Item -ItemType Directory -Force -Path "FinalOutput"
          
          # Search in the explicit AppxPackages directory first
          $searchPath = "${{ github.workspace }}\AppxPackages"
          if (-not (Test-Path $searchPath)) {
             Write-Host "AppxPackages path not found, searching entire workspace..."
             $searchPath = "."
          }

          $files = Get-ChildItem -Path $searchPath -Recurse -Include *.msixbundle, *.msix, *.appxbundle
          
          if ($files) {
              foreach ($f in $files) {
                  Write-Host "Found artifact: $($f.FullName)"
                  Copy-Item $f.FullName -Destination "FinalOutput"
              }
          } else {
              Write-Error "CRITICAL: No MSIX files found anywhere!"
              exit 1
          }
          
          if ($files) {
              foreach ($f in $files) {
                  Write-Host "Found artifact: $($f.FullName)"
                  Copy-Item $f.FullName -Destination "FinalOutput"
              }
          } else {
              Write-Error "No MSIX or MSIXBundle files found in output!"
              exit 1
          }

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            FinalOutput/*.msixbundle
            FinalOutput/*.msix
            FinalOutput/*.appxbundle
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}