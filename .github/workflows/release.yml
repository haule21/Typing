name: Publish Release Asset

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Restore dependencies
        run: dotnet restore

      - name: Create Signing Certificate
        run: |
          # Create Self-Signed Cert (Standard procedure for test/store association absent)
          # Note: For real Store distribution, you may replace this with a valid Store certificate from Secrets.
          $cert = New-SelfSignedCertificate -CertStoreLocation "cert:\CurrentUser\My" -Subject "CN=TypingApp" -KeyAlgorithm RSA -KeyLength 2048 -HashAlgorithm SHA256 -Type CodeSigningCert
          $pwd = ConvertTo-SecureString -String "TypingAppPassword" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "TypingCert.pfx" -Password $pwd

      - name: Build MSIX Package
        run: |
          # Use MSBuild to generate the MSIX Package
          # Removed PublishSingleFile to prevent crash issues (Event 10.3)
          # GenerateAppxPackageOnBuild=true triggers the packaging
          msbuild TypingApp.csproj /p:Configuration=Release /p:Platform=x64 `
            /p:WindowsPackageType=MSIX `
            /p:UapAppxPackageBuildMode=SideloadOnly `
            /p:AppxBundle=Always `
            /p:GenerateAppxPackageOnBuild=true `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="TypingCert.pfx" `
            /p:PackageCertificatePassword="TypingAppPassword" `
            /p:OutputPath="bin\Release\"

      - name: List Build Outputs (Debug)
        run: Get-ChildItem -Path bin\Release -Recurse

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            bin/Release/**/*.msixbundle
            bin/Release/**/*.msix
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}